<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Dock — Mobile</title>
  <style>
  :root{ --bg:#0f1222; --panel:#171a2f; --muted:#aab0d5; --accent:#7c9cff; --btnText:#061029 }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%; margin:0; background:radial-gradient(800px 400px at 10% 0%, #151737 0%, var(--bg) 60%); color:#e8eaf6; font-family:system-ui,Segoe UI,Roboto,Arial}
    .page{min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:18px}
    .card{background:var(--panel); padding:16px; border-radius:14px; width:100%; max-width:760px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    h2{margin:0 0 8px 0; font-size:18px}
    p.hint{margin:6px 0 12px 0; color:var(--muted); font-size:13px}
    input,select,button{font:inherit}
    .form-row{display:flex; gap:8px; margin-bottom:10px}
    .form-row input[type='text'], .form-row input[type='password'], select{flex:1; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,.06); background:#0f1230; color:#e8eaf6}
    .controls{display:grid; gap:12px}
    /* Buttons: large tap targets on mobile; compact grid on wider screens */
    .btn{padding:12px 10px; border-radius:10px; border:none; background:var(--accent); color:var(--btnText); width:100%; font-weight:700}
    .muted-btn{background:transparent; border:1px solid rgba(255,255,255,.06); color:var(--muted)}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
    .section{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); padding:10px; border-radius:10px}
    #status{min-height:20px; color:var(--muted); font-size:13px}
    /* Responsive tweaks */
    @media (max-width:640px){
      .card{padding:14px; border-radius:12px}
      .grid-2{grid-template-columns:1fr}
      .grid-3{grid-template-columns:1fr}
      .form-row input[type='text'], .form-row input[type='password']{padding:14px}
      .btn{padding:14px}
    }
    @media (min-width:900px){
      .page{align-items:center}
      .card{padding:20px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <h2>Teacher Dock</h2>
        <div style="font-size:12px;color:var(--muted)">Mobile · Tablet</div>
      </div>
      <p class="hint">Sign in to send remote controls to the classroom. Controls are large for touch and rearrange on wider screens.</p>

      <div class="section">
        <div class="form-row">
          <input id="email" placeholder="teacher@example.com" aria-label="Email" />
        </div>
        <div class="form-row">
          <input id="password" type="password" placeholder="password" aria-label="Password" />
        </div>
        <div class="grid-2" style="margin-top:6px">
          <button class="btn" id="btnSignIn">Sign In</button>
          <button class="btn muted-btn" id="btnResetPassword">Reset Password</button>
        </div>
        <div style="margin-top:8px; display:flex; justify-content:flex-end"><button class="btn muted-btn" id="btnSignOut" style="display:none">Sign Out</button></div>
        <div id="status" style="margin-top:8px"></div>
      </div>

      <div id="controls" class="controls" style="display:none;margin-top:12px">
        <div class="section">
          <label style="display:block;color:var(--muted);margin-bottom:6px">Boss Image Pack</label>
          <select id="cfgSubjectMobile" aria-label="Boss Image Pack">
            <option value="math">Math</option>
            <option value="phonics">Phonics</option>
            <option value="story-comprehension">Story Comprehension</option>
          </select>
        </div>

        <div class="section">
          <label style="display:block;color:var(--muted);margin-bottom:6px">Boss Hearts (1-20)</label>
          <input id="cfgBossHPMobile" type="number" min="1" max="20" value="8" aria-label="Boss Hearts" />
        </div>

        <div class="grid-2">
          <button class="btn" id="btnSendConfig">Apply Config</button>
          <button class="btn muted-btn" id="btnReset">Reset</button>
        </div>

        <div class="section">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-weight:700">Guild Controls</div>
            <div style="font-size:12px;color:var(--muted)">Tap once per action</div>
          </div>
          <div class="grid-3">
            <button class="btn" id="hit0">G1 Hit</button>
            <button class="btn" id="hit1">G2 Hit</button>
            <button class="btn" id="hit2">G3 Hit</button>
          </div>
          <div style="height:8px"></div>
          <div class="grid-3">
            <button class="btn muted-btn" id="miss0">G1 Miss</button>
            <button class="btn muted-btn" id="miss1">G2 Miss</button>
            <button class="btn muted-btn" id="miss2">G3 Miss</button>
          </div>
          <div style="height:8px"></div>
          <div class="grid-2">
            <button class="btn muted-btn" id="btnUndo">Undo</button>
            <button class="btn" id="btnResetBottom" style="display:none">Reset (alt)</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsTo0u0r4FaYgg8qg3PmU_FAHmJFWQ8WE",
      authDomain: "classroom-boss-fight.firebaseapp.com",
      projectId: "classroom-boss-fight",
      storageBucket: "classroom-boss-fight.firebasestorage.app",
      messagingSenderId: "44362539387",
      appId: "1:44362539387:web:a248b5c667604e89f19dde",
      databaseURL: "https://classroom-boss-fight-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const controlsRef = ref(db, 'controls/latest');

    const signInBtn = document.getElementById('btnSignIn'); if(signInBtn) signInBtn.addEventListener('click', async ()=>{
      const e = (document.getElementById('email')||{}).value || '';
      const p = (document.getElementById('password')||{}).value || '';
      try{
        const u = await signInWithEmailAndPassword(auth, e.trim(), p);
        const statusEl = document.getElementById('status'); if(statusEl) statusEl.textContent = `Signed in ${u.user.email}`;
        // Show controls now that teacher is signed in
        const controlsEl = document.getElementById('controls'); if(controlsEl) controlsEl.style.display = '';
      }catch(err){ console.error('signIn error', err); const statusEl = document.getElementById('status'); if(statusEl) statusEl.textContent = 'Sign-in failed: '+err.message }
    });

    // Reset password flow - uses Firebase Auth to send a reset email to the teacher's email
    const resetPwdBtn = document.getElementById('btnResetPassword'); if(resetPwdBtn) resetPwdBtn.addEventListener('click', async ()=>{
      const e = (document.getElementById('email')||{}).value || '';
      const statusEl = document.getElementById('status');
      if(!e.trim()){ if(statusEl) statusEl.textContent = 'Enter your email address first'; return; }
      try{
        await sendPasswordResetEmail(auth, e.trim()); if(statusEl) statusEl.textContent = 'Password reset email sent (check your inbox)';
      }catch(err){ console.error('reset error', err); if(statusEl) statusEl.textContent = 'Reset failed: '+err.message }
    });

    function send(action, payload){
      const id = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
      try{ window._localLastSentControlId = id; }catch(e){}
      return set(controlsRef, { id, action, payload, ts: Date.now() });
    }

    // update UI on auth changes, but don't redirect — teacher stays on phone to send controls
    onAuthStateChanged(auth, u=>{
      const statusEl = document.getElementById('status'); const controlsEl = document.getElementById('controls'); const signOutEl = document.getElementById('btnSignOut');
      if(u){ if(statusEl) statusEl.textContent = `Signed in ${u.email}`; if(controlsEl) controlsEl.style.display = ''; if(signOutEl) signOutEl.style.display = ''; }
      else { if(statusEl) statusEl.textContent='Not signed in'; if(controlsEl) controlsEl.style.display = 'none'; if(signOutEl) signOutEl.style.display = 'none'; }
    });

    // wire control buttons to send DB messages and update status (defensive)
    const safeSend = (act, payload, text)=>{ try{ send(act,payload).then(()=>{ const st = document.getElementById('status'); if(st) st.textContent = text; }).catch(e=>{ console.warn('send failed', e); }); }catch(e){ console.warn('safeSend error', e); } };
    const hit0 = document.getElementById('hit0'); if(hit0) hit0.addEventListener('click', ()=> safeSend('hit',{g:0}, 'Sent: guild 1 hit'));
    const hit1 = document.getElementById('hit1'); if(hit1) hit1.addEventListener('click', ()=> safeSend('hit',{g:1}, 'Sent: guild 2 hit'));
    const hit2 = document.getElementById('hit2'); if(hit2) hit2.addEventListener('click', ()=> safeSend('hit',{g:2}, 'Sent: guild 3 hit'));
    const miss0 = document.getElementById('miss0'); if(miss0) miss0.addEventListener('click', ()=> safeSend('miss',{g:0}, 'Sent: guild 1 miss'));
    const miss1 = document.getElementById('miss1'); if(miss1) miss1.addEventListener('click', ()=> safeSend('miss',{g:1}, 'Sent: guild 2 miss'));
    const miss2 = document.getElementById('miss2'); if(miss2) miss2.addEventListener('click', ()=> safeSend('miss',{g:2}, 'Sent: guild 3 miss'));
    const resetBtn = document.getElementById('btnReset'); if(resetBtn) resetBtn.addEventListener('click', ()=> safeSend('reset',{}, 'Sent: reset'));
    const undoBtn = document.getElementById('btnUndo'); if(undoBtn) undoBtn.addEventListener('click', ()=> safeSend('undo',{}, 'Sent: undo'));

    const signOutBtn = document.getElementById('btnSignOut'); if(signOutBtn) signOutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); const st = document.getElementById('status'); if(st) st.textContent='Signed out'; }catch(e){ console.warn(e); } });

    // send mobile config (subject, bossHP)
    const btnSendConfig = document.getElementById('btnSendConfig'); if(btnSendConfig) btnSendConfig.addEventListener('click', ()=>{
      const subj = (document.getElementById('cfgSubjectMobile')||{}).value || 'math';
      const hp = parseInt((document.getElementById('cfgBossHPMobile')||{}).value,10) || 8;
      safeSend('config', { subject: subj, bossHP: Math.max(1, Math.min(20, hp)) }, 'Sent: config');
    });
  </script>
</body>
</html>
