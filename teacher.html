<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Dock — Mobile</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0f1222;color:#e8eaf6;display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px}
    .card{background:#171a2f;padding:14px;border-radius:12px;width:100%;max-width:420px}
    input,button{font:inherit}
    .gRow{display:flex;gap:8px}
    .btn{padding:10px;border-radius:8px;border:none;background:#7c9cff;color:#061029;width:100%}
  </style>
</head>
<body>
  <h2>Teacher Dock</h2>
  <div class="card">
    <div style="margin-bottom:8px;color:#aab0d5;font-size:13px">Sign in as teacher</div>
    <input id="email" placeholder="teacher@example.com" style="width:100%;padding:8px;margin-bottom:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:#0f1230;color:#e8eaf6" />
    <input id="password" type="password" placeholder="password" style="width:100%;padding:8px;margin-bottom:8px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:#0f1230;color:#e8eaf6" />
    <div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn" id="btnSignIn">Sign In</button><button class="btn" id="btnResetPassword">Reset Password</button><button class="btn" id="btnSignOut">Sign Out</button></div>
    <div id="status" style="margin-top:10px;color:#aab0d5;font-size:13px"></div>

    <div id="controls" style="margin-top:12px;display:none">
      <div style="height:8px"></div>
      <div style="margin-bottom:10px;">
        <label style="display:block;color:#aab0d5;margin-bottom:6px">Boss Image Pack</label>
        <select id="cfgSubjectMobile" style="width:100%;padding:8px;border-radius:8px;background:#0f1230;color:#e8eaf6;border:1px solid rgba(255,255,255,.06)">
          <option value="math">Math</option>
          <option value="phonics">Phonics</option>
          <option value="story-comprehension">Story Comprehension</option>
        </select>
      </div>
      <div style="margin-bottom:10px;">
        <label style="display:block;color:#aab0d5;margin-bottom:6px">Boss Hearts (1-20)</label>
        <input id="cfgBossHPMobile" type="number" min="1" max="20" value="8" style="width:100%;padding:8px;border-radius:8px;background:#0f1230;color:#e8eaf6;border:1px solid rgba(255,255,255,.06)" />
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn" id="btnSendConfig">Apply Config</button></div>
      <div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn" id="hit0">Guild 1 Hit</button><button class="btn" id="miss0">Guild 1 Miss</button></div>
      <div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn" id="hit1">Guild 2 Hit</button><button class="btn" id="miss1">Guild 2 Miss</button></div>
      <div style="display:flex;gap:8px;margin-bottom:8px"><button class="btn" id="hit2">Guild 3 Hit</button><button class="btn" id="miss2">Guild 3 Miss</button></div>
      <div style="display:flex;gap:8px;margin-top:10px"><button class="btn" id="btnReset">Reset</button><button class="btn" id="btnUndo">Undo</button></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsTo0u0r4FaYgg8qg3PmU_FAHmJFWQ8WE",
      authDomain: "classroom-boss-fight.firebaseapp.com",
      projectId: "classroom-boss-fight",
      storageBucket: "classroom-boss-fight.firebasestorage.app",
      messagingSenderId: "44362539387",
      appId: "1:44362539387:web:a248b5c667604e89f19dde",
      databaseURL: "https://classroom-boss-fight-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const controlsRef = ref(db, 'controls/latest');

    document.getElementById('btnSignIn').onclick = async ()=>{
      const e = document.getElementById('email').value.trim();
      const p = document.getElementById('password').value;
      try{
        const u = await signInWithEmailAndPassword(auth, e, p);
        document.getElementById('status').textContent = `Signed in ${u.user.email}`;
        // Show controls now that teacher is signed in
        document.getElementById('controls').style.display = '';
      }catch(err){ console.error('signIn error', err); document.getElementById('status').textContent = 'Sign-in failed: '+err.message }
    };

    // Reset password flow - uses Firebase Auth to send a reset email to the teacher's email
    document.getElementById('btnResetPassword').onclick = async ()=>{
      const e = document.getElementById('email').value.trim();
      if(!e){ document.getElementById('status').textContent = 'Enter your email address first'; return; }
      try{
        await sendPasswordResetEmail(auth, e);
        document.getElementById('status').textContent = 'Password reset email sent (check your inbox)';
      }catch(err){ console.error('reset error', err); document.getElementById('status').textContent = 'Reset failed: '+err.message }
    };

    function send(action, payload){
      const id = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
      return set(controlsRef, { id, action, payload, ts: Date.now() });
    }

    // update UI on auth changes, but don't redirect — teacher stays on phone to send controls
    onAuthStateChanged(auth, u=>{
      if(u){
        document.getElementById('status').textContent = `Signed in ${u.email}`;
        document.getElementById('controls').style.display = '';
        document.getElementById('btnSignOut').style.display = '';
      } else {
        document.getElementById('status').textContent='Not signed in';
        document.getElementById('controls').style.display = 'none';
        document.getElementById('btnSignOut').style.display = 'none';
      }
    });

    // wire control buttons to send DB messages and update status
    document.getElementById('hit0').onclick = ()=> send('hit', { g:0 }).then(()=>document.getElementById('status').textContent='Sent: guild 1 hit');
    document.getElementById('hit1').onclick = ()=> send('hit', { g:1 }).then(()=>document.getElementById('status').textContent='Sent: guild 2 hit');
    document.getElementById('hit2').onclick = ()=> send('hit', { g:2 }).then(()=>document.getElementById('status').textContent='Sent: guild 3 hit');
    document.getElementById('miss0').onclick = ()=> send('miss', { g:0 }).then(()=>document.getElementById('status').textContent='Sent: guild 1 miss');
    document.getElementById('miss1').onclick = ()=> send('miss', { g:1 }).then(()=>document.getElementById('status').textContent='Sent: guild 2 miss');
    document.getElementById('miss2').onclick = ()=> send('miss', { g:2 }).then(()=>document.getElementById('status').textContent='Sent: guild 3 miss');
    document.getElementById('btnReset').onclick = ()=> send('reset', {}).then(()=>document.getElementById('status').textContent='Sent: reset');
    document.getElementById('btnUndo').onclick = ()=> send('undo', {}).then(()=>document.getElementById('status').textContent='Sent: undo');

    document.getElementById('btnSignOut').onclick = async ()=>{ try{ await signOut(auth); document.getElementById('status').textContent='Signed out'; }catch(e){ console.warn(e); } };

    // send mobile config (subject, bossHP)
    document.getElementById('btnSendConfig').onclick = ()=>{
      const subj = document.getElementById('cfgSubjectMobile').value;
      const hp = parseInt(document.getElementById('cfgBossHPMobile').value,10) || 8;
      send('config', { subject: subj, bossHP: Math.max(1, Math.min(20, hp)) }).then(()=>document.getElementById('status').textContent='Sent: config');
    };
  </script>
</body>
</html>
